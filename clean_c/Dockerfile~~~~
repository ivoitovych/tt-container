# Dockerfile for TT-Metal and TT-Train - Fully Self-Contained Build
FROM ubuntu:22.04

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# Enable DPRINT for Tenstorrent debugging
ENV TT_METAL_DPRINT_CORES=0
ENV ENABLE_DPRINT=1

# Update and upgrade system packages
RUN apt-get update && \
    apt-get upgrade -y && \
    apt-get install -y \
    python3 python3-pip python3-venv \
    git git-lfs \
    cargo \
    wget \
    libstdc++-12-dev \
    libmpfr-dev \
    ccache \
    build-essential \
    cmake \
    ninja-build \
    libyaml-cpp-dev \
    libboost-all-dev \
    libgtest-dev \
    libhwloc-dev \
    libssl-dev \
    pkg-config \
    software-properties-common \
    curl \
    sudo \
    vim \
    openssh-client \
    && rm -rf /var/lib/apt/lists/*

# Set up git to use SSH
RUN git config --global url."git@github.com:".insteadOf "https://github.com/"

# Create working directory
WORKDIR /workspace

# Install Python packages globally
RUN pip3 install --upgrade pip && \
    pip3 install numpy wheel setuptools

# Setup SSH for GitHub (will use mounted keys at runtime for private repos)
RUN mkdir -p /root/.ssh && \
    ssh-keyscan github.com >> /root/.ssh/known_hosts

# Build and install GDB for debugging
RUN wget https://ftp.gnu.org/gnu/gdb/gdb-15.1.tar.gz && \
    tar -xzf gdb-15.1.tar.gz && \
    cd gdb-15.1 && \
    ./configure --with-python && \
    make -j$(nproc) && \
    make install && \
    cd .. && \
    rm -rf gdb-15.1 gdb-15.1.tar.gz

# Clone and setup tt-smi (monitoring tool)
RUN --mount=type=ssh git clone git@github.com:tenstorrent/tt-smi.git && \
    cd tt-smi && \
    python3 -m venv .venv && \
    . .venv/bin/activate && \
    pip3 install --upgrade pip && \
    pip install . && \
    deactivate

# Clone tt-metal repository with all submodules
RUN --mount=type=ssh \
    git clone git@github.com:tenstorrent/tt-metal.git && \
    cd tt-metal && \
    git submodule update --init --recursive && \
    git submodule foreach 'git lfs fetch --all && git lfs pull'

# Setup tt-metal build environment
WORKDIR /workspace/tt-metal

# Install additional dependencies that tt-metal's install_dependencies.sh would install
RUN apt-get update && \
    apt-get install -y \
    libnuma-dev \
    libgmp-dev \
    libmpfr-dev \
    libmpc-dev \
    libisl-dev \
    libzip-dev \
    libtinfo5 \
    libxml2-dev \
    libzmq3-dev \
    direnv \
    && rm -rf /var/lib/apt/lists/*

# Build tt-metal in debug mode with all components
# Note: TT-Metal will use its own LLVM/Clang toolchain
RUN export ARCH_NAME=wormhole_b0 && \
    export TT_METAL_HOME=/workspace/tt-metal && \
    export PYTHONPATH=$TT_METAL_HOME:${PYTHONPATH:-} && \
    ./build_metal.sh --debug --build-all --enable-ccache

# Setup Python virtual environment for tt-metal
RUN python3 -m venv /workspace/tt-metal-venv && \
    . /workspace/tt-metal-venv/bin/activate && \
    pip install --upgrade pip && \
    pip install -e . && \
    if [ -f requirements.txt ]; then pip install -r requirements.txt; fi && \
    if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi && \
    deactivate

# Install CMake 3.30 for tt-train
RUN wget https://github.com/Kitware/CMake/releases/download/v3.30.0/cmake-3.30.0-linux-x86_64.tar.gz && \
    tar -xzf cmake-3.30.0-linux-x86_64.tar.gz && \
    cp -r cmake-3.30.0-linux-x86_64/* /usr/local/ && \
    rm -rf cmake-3.30.0-linux-x86_64 cmake-3.30.0-linux-x86_64.tar.gz && \
    cmake --version

# Setup and build tt-train (subfolder in tt-metal)
WORKDIR /workspace/tt-metal/tt-train

# Initialize tt-train repository environment
RUN if [ -f init_repo.sh ]; then \
    . ./init_repo.sh || echo "tt-train init_repo.sh completed"; \
    fi

# Build tt-train in both Debug and Release modes
RUN if [ -d "/workspace/tt-metal/tt-train" ]; then \
    cmake -DCMAKE_BUILD_TYPE=Debug -B build-debug -GNinja && \
    cmake --build build-debug --config Debug && \
    cmake -DCMAKE_BUILD_TYPE=Release -B build-release -GNinja && \
    cmake --build build-release --config Release; \
    fi

# Install additional dependencies for tt-train if needed
RUN . /workspace/tt-metal-venv/bin/activate && \
    pip install wandb msgpack-python && \
    deactivate

# Create alias for tt-metal python venv
RUN echo 'alias tt-venv="source /workspace/tt-metal-venv/bin/activate"' >> /root/.bashrc && \
    echo 'echo "TT-Metal Development Environment"' >> /root/.bashrc && \
    echo 'echo "Run tt-venv to activate the Python environment"' >> /root/.bashrc && \
    echo 'echo ""' >> /root/.bashrc

# Set environment variables for runtime
ENV PYTHONPATH=/workspace/tt-metal:${PYTHONPATH}
ENV TT_METAL_HOME=/workspace/tt-metal
ENV ARCH_NAME=wormhole_b0

# Default working directory
WORKDIR /workspace/tt-metal

# Default command
CMD ["/bin/bash"]

